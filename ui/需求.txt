智能表格问答系统 (TableTalk AI) 详细设计说明书1. 模块化解耦设计 (Decoupled Architecture)为了确保前端风格与后端逻辑的独立性，系统划分为以下六个核心模块：模块名称文件名核心职责配置中心config.py存储全局常量、Prompt 模板、UI 自定义 CSS 及 API 参数。数据模型models.py定义 SQLAlchemy ORM 对象（用户、文件、聊天记录）。持久化层db_manager.py封装数据库 CRUD 操作，处理文件物理路径与数据库记录的同步。安全认证auth_utils.py处理 Bcrypt 密码加密、Session 登录状态维护及权限校验。业务逻辑llm_service.py处理多格式（CSV/TSV/Excel）读取、表格序列化及大模型 API 调用。交互界面app.py基于 Streamlit 渲染 UI，管理组件状态，调用各层接口。2. 多格式数据处理流程系统需具备兼容多种结构化文件的能力，核心逻辑位于业务逻辑层。2.1 智能读取机制后缀识别：根据文件扩展名（.csv, .tsv, .xlsx）分流。编码检测：针对 CSV/TSV，使用 chardet 自动识别编码（如 UTF-8, GBK），防止乱码导致模型解析失败。分隔符判定：针对文本类表格，自动区分逗号（CSV）与制表符（TSV）。异常拦截：若文件读取后 df.empty 为真，立即向 UI 抛出错误，终止后续 API 消耗。3. 多用户隔离与持久化方案这是系统“非简陋”的核心，确保私密性与连贯性。3.1 物理与逻辑双重隔离逻辑隔离：数据库查询指令强制带入 current_user_id 过滤条件（如 WHERE user_id = :uid）。物理隔离：上传文件存储路径遵循 ./storage/{user_id}/{file_id}_{filename} 规则。3.2 对话持久化逻辑当用户在侧边栏切换历史文件时，系统触发以下流程：清空当前页面 st.session_state.messages。从数据库 chat_messages 表中按 timestamp 顺序提取该 file_id 下的所有记录。重新渲染对话气泡，实现“记忆恢复”。4. Zero-Shot 问答与 Prompt 工程由于不生成代码，问答的准确性完全取决于如何将表格呈现给模型。4.1 表格序列化策略 (Table to Text)系统将 DataFrame 转换为带有对齐线的 Markdown Table。优势：Markdown 格式保留了明确的行列边界信息，是大模型（尤其是 GPT 系列）理解结构化数据效果最好的格式。采样处理：针对超过 Token 限制的长表，保留表头 + 前 N 行 + 后 N 行，并在 Prompt 中加入“数据采样说明”。4.2 结构化 Prompt 模板存储于 config.py，设计如下：角色声明：定义模型为高级数据分析师。数据注入：插入 Markdown 格式的表格原文。约束指令：明确要求仅基于提供的数据回答；无法回答时拒绝承认；禁止输出非相关内容。5. UI/UX 设计规范 (现代感增强)配色方案：采用简约白与科技蓝，侧边栏使用浅灰色背景区分功能区。交互反馈：Loading 态：调用 LLM 时，输入框下方显示 st.spinner("AI 正在思考数据...")。流式渲染：模拟逐字生成效果。即时同步：删除文件后，侧边栏列表立即刷新，工作区自动返回待上传状态。6. 安全与健壮性设计密码安全：禁止存储明文，统一使用 Bcrypt 进行单向哈希。文件清理保障：在删除文件的方法中，采用 try...except 结构，确保即便物理文件删除失败，数据库记录也能正确回滚或记录异常日志。注入防护：使用 SQLAlchemy 参数化查询，防止 SQL 注入。